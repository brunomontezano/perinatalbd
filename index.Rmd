---
title: "Fatores perinatais e desenvolvimento de transtorno bipolar"
author: "Bruno Montezano"
date: "`r Sys.Date()`"
lang: "pt-br"
output:
    html_document:
        theme: "united"
        highlight: "zenburn"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=8)
```

## Introdução

O presente trabalho almeja observar os efeitos de fatores perinatais e do
aleitamento materno no desenvolvimento de transtorno bipolar (TB) aos 22 anos
de idade. Os dados utilizados para tal foram coletados em uma coorte de
nascimento coordenada pelo Centro de Epidemiologia da Universidade Federal
de Pelotas intitulada "Coorte de 1993".

```{r}
# Carrega dados da Coorte de 1993
dados_coorte <- haven::read_sav("data/banco_QI_15_07.sav")
```

## Transtorno bipolar

O diagnóstico de transtorno bipolar será calculado pela MINI
(Mini International Neuropsychiatric Interview) por meio dos critérios
diagnósticos do DSM-IV. Serão calculados diagnósticos de transtorno
bipolar tipo I e transtorno bipolar tipo II.

### Criação das variáveis de episódio de humor e filtragem para reter variáveis perinatais

```{r}
# Vetor com as variáveis perinatais indicadas pela pesquisadora para
# construção de novas features
vars_vanessa <- c("apartip", "ainduz", "aprobrn", "aerrado",
"aprobrn", "aprobrn1", "aprobrn2", "aprobrn3",
"aprobrn", "aprobrn1", "aprobrn2", "aprobrn3",
"aprobrn", "aprobrn1", "aprobrn2", "aprobrn3",
"aprobrn", "aprobrn1", "aprobrn2", "aprobrn3",
"ahipert", "adiabet", "ainfecur", "aoutinf",
"aanemia", "amotcesa", "apartind", "afumou",
"acompfum", "abebalc", "aalcool", "avivmar",
"asexrn", "apesorn", "acompr", "apcrn", "aescol3",
"aescpai", "aparidad", "aapoio", "aidadmae",
"aidadpai", "apretama", "aapgar1", "aapgar5",
"arenfam")

# Filtrar base para manter subamostra da avaliação aos 22 anos
# Transformar variáveis com rótulos em variáveis tipo fator
# Criar subconjunto com variável diagnóstico e variáveis perinatais
da <- dados_coorte |> 
    dplyr::filter(!is.na(TB_final)) |> 
    haven::as_factor() |> 
    dplyr::select(TB_final, dplyr::any_of(vars_vanessa))
```

### Criação do diagnóstico de TB

Além da manutenção de variável de TB, a base de dados foi filtrada para manter
somente os sujeitos avaliados aos 22 anos (através da filtragem por meio de uma
variável de diagnóstico da doença da avaliação em 2015).

Abaixo, segue um gráfico de barras com a proporção de bipolares e não-bipolares
na amostra:

```{r}
da |> 
    dplyr::count(TB_final) |> 
    ggplot2::ggplot(ggplot2::aes(x = TB_final, y = n)) +
    ggplot2::geom_col(fill = "royalblue") +
    ggplot2::geom_text(ggplot2::aes(label = n), vjust = -0.5, size = 5) +
    ggnuplot::theme_gnuplot(base_size = 20) +
    ggplot2::labs(x = "Diagnóstico", y = "Número de sujeitos")
```

## Fatores perinatais e transtorno bipolar

### Construção de variáveis e técnicas de imputação

As seguintes variáveis foram construídas:

- `tb_dic`: Diagnóstico de TB tipo I ou TB tipo II (dicotômica)
- `cesarea`: O parto foi cesária?
- `parto_induzido`: A bolsa rompeu, foi utilizado soro ou ambas as coisas?
- `uti_neo`: O recém-nascido foi para UTI?
- `prematuro`: O bebê nasceu prematuro?
- `traumatismo`: O bebê apresentou
traumatismo no parto?
- `disf_resp`: O bebê apresentou disfunção respiratória no parto?
- `malform`: Apresentou malformação no parto?
- `sofrfetal`: Apresentou sofrimento fetal?
- `has_materna`: Hipertensão arterial materna
- `dm_materna`: Diabetes materna
- `ifec_gest`: Infecção gestacional
- `anemia_gest`: Anemia gestacional
- `hemorr_parto`: Apresentou hemorragia no parto
- `tab_gest`: Fumou na gestação
- `tab_pass_gest`: Fumo passivo na gestação
- `etil_pesado_gest`: Etilismo pesado na gestação
- `rup_famil`: Ruptura familiar
- `baixo_peso`: Baixo peso ao nascer
- `baixo_comp`: Baixo comprimento ao nascer
- `perf_cef_curto`: Perímetro cefálico curto
- `baixa_escol_paterna`: Baixa escolaridade paterna (<= 3 anos de estudo)
- `paridade_4_ou_mais`: Paridade (dicotômica)
- `apoio_familiar`: Teve apoio da famíla/vizinhos/amigos?
- `idade_mae_20`: Idade da mãe (< 20 anos)
- `idade_mae_34`: Idade da mãe (< 34 anos)
- `pretende_amamentar`: Mãe pretende amamentar
- `apgar_1`: Apgar no minuto 1 (menor que 7)
- `apgar_5`: Apgar no minuto 5 (menor que 7)
- `renda_familiar`: Renda familiar (em salários mínimos)

```{r}
da_proc <- da |>
    dplyr::transmute(
        tb_dic = factor(dplyr::if_else(TB_final == 1,
                                         "Sim",
                                         "Não"
                                         ),
                        levels = c("Não", "Sim")
                           ),
        cesarea = as.factor(dplyr::if_else(apartip == "normal",
                                           "Não",
                                           "Sim"
                                           )
                            ),
        parto_induzido = as.factor(dplyr::if_else(
            ainduz %in% c("rompeu bolsa", "soro", "ambos"),
            "Sim",
            "Não"
        )),
        uti_neo = as.factor(dplyr::if_else(
            aprobrn %in% c("bercario", "aloj.conjunto"),
            "Não",
            dplyr::if_else(aprobrn == "uti", "Sim",
                           NA_character_
                           )
        )),
        prematuro = as.factor(
            dplyr::if_else(aerrado != "prematuro" | is.na(aerrado),
                           "Não",
                           "Sim"
                           )
        ),
        traumatismo = as.factor(
            dplyr::if_else(
                aprobrn1 == "traumatismo" | aprobrn2 == "traumatismo" |
                    aprobrn3 == "traumatismo",
                "Sim",
                "Não",
                missing = "Não"
            )
        ),
        disf_resp = as.factor(
            dplyr::if_else(
                aprobrn1 == "stress resp" | aprobrn2 == "stress resp" |
                    aprobrn3 == "stress resp",
                "Sim",
                "Não",
                missing = "Não"
            )
        ),
        malform = as.factor(
            dplyr::if_else(
                aprobrn1 == "malformacao" | aprobrn2 == "malformacao" |
                    aprobrn3 == "malformacao",
                "Sim",
                "Não",
                missing = "Não"
            )
        ),
        sofrfetal = as.factor(
            dplyr::if_else(
                aprobrn1 == "sofrim fetal" | aprobrn2 == "sofrim fetal" |
                    aprobrn3 == "sofrim fetal",
                "Sim",
                "Não",
                missing = "Não"
            )
        ),
        has_materna = as.factor(dplyr::if_else(
            ahipert %in% c("tratado", "nao tratado"),
            "Sim",
            "Não"
        )),
        dm_materna = as.factor(dplyr::if_else(
            adiabet %in% c("tratado", "nao tratado"),
            "Sim",
            "Não"
        )),
        infec_gest = as.factor(
            dplyr::if_else(
                ainfecur %in% c("tratado", "nao tratado") |
                    aoutinf %in% c("tratado", "nao tratado"),
                "Sim",
                "Não"
            )
        ),
        anemia_gest = as.factor(dplyr::if_else(
            aanemia %in% c("tratado", "nao tratado"),
            "Sim",
            "Não"
        )),
        hemorr_parto = as.factor(
            dplyr::if_else(
                amotcesa == "hemorragia materna" | apartind == "sangramento",
                "Sim",
                "Não"
            )
        ),
        tab_gest = as.factor(
            dplyr::if_else(afumou == "sim",
                           "Sim",
                           "Não"
                           )
        ),
        tab_pass_gest = as.factor(
            dplyr::if_else(acompfum == "sim",
                           "Sim",
                           "Não"
                           )
        ),
        etil_pesado_gest = as.factor(
            dplyr::if_else(abebalc == "sim",
                           "Sim",
                           "Não"
                           )
        ),
        rup_famil = as.factor(
            dplyr::if_else(avivmar == "sim",
                           "Não",
                           "Sim"
                           )
        ),
       baixo_peso = as.factor(
           dplyr::if_else(apesorn < 2500,
                          "Sim",
                          "Não"
                          )
       ),
       baixo_comp = as.factor(
           dplyr::if_else(acompr < 47,
                          "Sim",
                          "Não"
                          )
       ),
       per_cef_curto = as.factor(
           dplyr::if_else(apcrn < 33,
                          "Sim",
                          "Não"
                          )
       ),
       baixa_escol_paterna = as.factor(
           dplyr::if_else(
               aescpai <= 3,
               "Sim",
               "Não"
           )
       ),
       paridade_4_ou_mais = as.factor(
           dplyr::if_else(
               aparidad %in% c("0", "1", "2", "3"),
               "Não",
               "Sim"
           )
       ),
       apoio_familiar = as.factor(
           dplyr::if_else(
               aapoio == "sim",
               "Sim",
               "Não"
           )
       ),
       idade_mae_20 = as.factor(
           dplyr::if_else(
               aidadmae < 20,
               "Menor que 20",
               "Maior ou igual a 20"
           )
       ),
       idade_mae_34 = as.factor(
           dplyr::if_else(
               aidadmae < 34,
               "Menor que 34",
               "Maior ou igual que 34"
           )
       ),
       pretende_amamentar = as.factor(
           dplyr::if_else(
               apretama == "sim",
               "Sim",
               "Não"
           )
       ),
       apgar_1 = as.factor(
           dplyr::if_else(
               aapgar1 < 7,
               "Menor que 7",
               "Maior ou igual a 7"
           )
       ),
       apgar_5 = as.factor(
           dplyr::if_else(
               aapgar5 < 7,
               "Menor que 7",
               "Maior ou igual a 7"
           )
       ),
       renda_familiar = arenfam
    )
```

Nesta etapa abaixo, realizou-se uma
checagem em relação aos valores ausentes
em cada uma das variáveis. Posteriormente,
elaborou-se um pequeno fluxo para realizar
a imputação das variáveis por meio de média
(variáveis numéricas) e moda (variáveis
categóricas).

```{r}
# Checar valores ausentes após criação das variáveis propostas
da_proc |> 
    purrr::map_if(is.factor, \(x) table(x, useNA = "always"), .else = summary)

# Criar base com variáveis imputadas pela moda e média
da_imp <- da_proc |> 
    recipes::recipe(tb_dic ~ .) |> 
    recipes::step_impute_mode(recipes::all_nominal_predictors()) |> 
    recipes::step_impute_mean(recipes::all_numeric_predictors()) |> 
    recipes::prep() |> 
    recipes::bake(new_data = NULL)

# Checar que a imputação funcionou
da_imp |> 
    purrr::map_if(is.factor, \(x) table(x, useNA = "always"), .else = summary)
```

```{r}
# Checar frequência agrupada pelo desfecho
ver_freq <- function(var) {
    
    da_imp |> 
        dplyr::group_by(tb_dic) |> 
        dplyr::count({{ var }})
    
}

da_imp |> 
    dplyr::select(-renda_familiar) |> 
    purrr::map_if(is.factor, ver_freq)
```


### Análise bivariada com variáveis categóricas

```{r}
library(magrittr, include.only = "%>%")

cat_biv <- da_imp |>
    purrr::keep(is.factor) |>
    tidyr::pivot_longer(names_to = "variable", values_to = "value", -tb_dic) |>
    dplyr::group_by(variable) %>%
    dplyr::do(chisq.test(.$tb_dic, .$value, simulate.p.value = TRUE) |>
                  broom::tidy()) |> 
    dplyr::select(-c(parameter, method)) |> 
    dplyr::filter(p.value < 0.05)

knitr::kable(cat_biv)
```

### Análise bivariada com variáveis numéricas

```{r}
num_biv <- da_imp |>
    dplyr::select(tb_dic, where(is.numeric)) |>
    tidyr::pivot_longer(names_to = "variable", values_to = "value", -tb_dic) |>
    dplyr::group_by(variable) %>%
    dplyr::do(t.test(.$value ~ .$tb_dic) |>
                  broom::tidy())

knitr::kable(num_biv)
```

### Análise multivariada

A imputação foi realizada nos passos anteriores para a análise bivariada, logo, o
objeto da base de dados imputada (pré-processada) será usada para o ajuste do modelo
de regressão logística binomial.

```{r, warning = FALSE}
mod <- parsnip::logistic_reg() |> 
    parsnip::set_mode("classification") |> 
    parsnip::set_engine("glm")

mod_fit <- mod |> 
    parsnip::fit(tb_dic ~ ., data = da_imp)

resumo_fit <- mod_fit |> 
    broom::tidy() |> 
    dplyr::filter(p.value < 0.05) |> 
    dplyr::mutate(
        or = exp(estimate)
    )

knitr::kable(resumo_fit)
```

#### Plot com OR

```{r, warning = FALSE}
mod_fit |> 
    broom::tidy() |> 
    dplyr::transmute(
        variavel = term,
        or = exp(estimate),
        erro_padrao = std.error
        ) |> 
    dplyr::filter(variavel != "(Intercept)" & or < 10) |> 
    ggplot2::ggplot() +
    ggplot2::aes(x = or, y = variavel) +
    ggplot2::geom_point(size = 5, color = "royalblue") +
    ggplot2::geom_linerange(
        ggplot2::aes(xmin = or-erro_padrao, xmax = or+erro_padrao),
        color = "royalblue",
        size = 0.8) +
    ggplot2::geom_vline(xintercept = 1) +
    ggplot2::scale_x_continuous(limits = c(0, 2.5)) +
    ggplot2::labs(x = "Razão de chances", y = "Variável") +
    ggnuplot::theme_gnuplot(base_size = 15)
```




