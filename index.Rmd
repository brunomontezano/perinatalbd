---
title: "Fatores perinatais e desenvolvimento de transtorno bipolar"
author: "Bruno Montezano"
date: "`r Sys.Date()`"
lang: "pt-br"
output:
    html_document:
        theme: "united"
        highlight: "zenburn"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=8)
```

## Introdução

O presente trabalho almeja observar os efeitos de fatores perinatais e do
aleitamento materno no desenvolvimento de transtorno bipolar (TB) aos 22 anos
de idade. Os dados utilizados para tal foram coletados em uma coorte de
nascimento coordenada pelo Centro de Epidemiologia da Universidade Federal
de Pelotas intitulada "Coorte de 1993".

```{r}
dados <- haven::read_dta("data/coorte_1993.dta")
```

## Transtorno bipolar

O diagnóstico de transtorno bipolar será calculado pela MINI
(Mini International Neuropsychiatric Interview) por meio dos critérios
diagnósticos do DSM-IV. Serão calculados diagnósticos de transtorno
bipolar tipo I, transtorno bipolar tipo II e transtorno bipolar não
especificado.

### Criação das variáveis de episódio de humor

```{r}
dados <- dados |>
    dplyr::mutate(
        ep_hipo =  ifelse(((kmini23 + kmini24 + kmini25 + kmini26 + kmini27 +
                                kmini28 + kmini29 > 2) |
                               (kmini19 == 0 | kmini20 == 0) &
                               (kmini23 + kmini24 + kmini25 + kmini26 +
                                    kmini27 + kmini28 + kmini29 > 3)
        ) &
            ((
                kmini30 == 0 | kmini32 == 0
            ) &
                kmini31 == 0),
        1, 0),
        ep_mania = ifelse(((kmini23 + kmini24 + kmini25 + kmini26 + kmini27 +
                                kmini28 + kmini29 > 2) |
                               (kmini19 == 0 | kmini20 == 0) &
                               (kmini23 + kmini24 + kmini25 + kmini26 +
                                    kmini27 + kmini28 + kmini29 > 3)
        ) &
            ((
                kmini30 == 1 & kmini32 == 1
            ) | kmini31 == 1),
        1, 0),
        ep_dep = ifelse(((((kmini1 == 1 |
                                kmini2 == 1) &
                               (kmini3 + kmini4 + kmini5 + kmini6 + kmini7 + kmini8 + kmini9) > 2
        )) |
            ((kmini1 == 0 |
                  kmini2 == 0) &
                 (kmini3 + kmini4 + kmini5 + kmini6 + kmini7 + kmini8 + kmini9 > 3)
            )) | (kmini10 == 1 & kmini11 == 1), 1, 0),
    )
```

### Criação do diagnóstico de TB

Além da criação de variável de TB, a base de dados será filtrada para manter
somente os sujeitos avaliados aos 22 anos (através da filtragem por meio de uma
variável da MINI da avaliação em 2015).

```{r}
dados <- dados |> 
    dplyr::mutate(
        tb = as.factor(
            dplyr::case_when(
                (ep_mania == 1) | (ep_dep == 1 & ep_hipo == 1) ~ "TB",
                TRUE ~ "Controle"
            )
        )
    ) |>
    dplyr::filter(!is.na(l063))
```

```{r}
dados |> 
    dplyr::count(tb) |> 
    ggplot2::ggplot(ggplot2::aes(x = tb, y = n)) +
    ggplot2::geom_col(fill = "royalblue") +
    ggplot2::geom_text(ggplot2::aes(label = n), vjust = -0.5, size = 5) +
    ggnuplot::theme_gnuplot(base_size = 20) +
    ggplot2::labs(x = "Diagnóstico", y = "Número de sujeitos")
```

## Fatores perinatais e transtorno bipolar

### Análise bivariada

```{r}
# TODO na quarta 11/05
# checar variáveis da Vanessa e limpar a base
# calcular variáveis que a Vanessa propos no Google Docs
# calcular qui-quadrado e teste t para as variáveis (talvez uma função para rodar mann-whitney, avaliar necessidade)
# modelos multivariados (reg logistica)

# Vetor com as variáveis indicadas pela Vanessa
vars_vanessa <- c("apartip", "ainduz", "aprobrn", "aerrado",
"aprobrn", "aprobrn1", "aprobrn2", "aprobrn3",
"aprobrn", "aprobrn1", "aprobrn2", "aprobrn3",
"aprobrn", "aprobrn1", "aprobrn2", "aprobrn3",
"aprobrn", "aprobrn1", "aprobrn2", "aprobrn3",
"ahipert", "adiabet", "ainfecuri", "aoutinf",
"aanemia", "amotcesar", "apartindu", "afumou",
"acompfumo", "qualquer", "aalcool", "avivmar",
"asexrn", "apesorn", "acompr", "apcrn", "aescol3",
"aescpai", "aparid4", "aapoio", "aidam20",
"aidam34", "apretamam", "aapgar1", "aapgar5")

# Pega dados do período perinatal
dados_peri <- dados |> 
    dplyr::select(tb, dplyr::starts_with("a")) |> 
    haven::as_factor()

# Selecionar TB e variáveis sugeridas pela Vanessa
dados_vanessa <- dados_peri |> 
    dplyr::select(tb, dplyr::one_of(vars_vanessa))

# Dar um look nas variáveis categóricas
dados_vanessa |> 
    purrr::keep(is.factor) |> 
    purrr::map(table, useNA = "always")

# Verificar frequễncia fumar na gravidez/TB
dados_vanessa |> 
    dplyr::group_by(afumou) |> 
    dplyr::count(tb) |> 
    dplyr::mutate(perc = n/sum(n))

# Para usar .$var
library(magrittr, include.only = "%>%")

# Troubleshooting no problema do qui-quadrado
dados_peri |> 
    purrr::keep(is.factor) |> 
    purrr::map(droplevels) |> 
    purrr::map(levels) |> 
    purrr::keep(\(x) length(x) < 2)

# Rodar qui-quadrado para todas categóricas
dados_peri %>%
    dplyr::select(-aruptur, -azona) |> 
    purrr::keep(is.factor) %>%
    purrr::keep(\(x) length(levels(x)) == 2) |> 
    tidyr::pivot_longer(names_to = "variable", values_to = "value", -tb) %>%
    dplyr::group_by(variable) %>%
    dplyr::do(chisq.test(.$tb, .$value, simulate.p.value = TRUE) %>%
                  broom::tidy()
              )

# Pegar nomes das variáveis perinatais categóricas
fatores <- dados_peri |> 
    purrr::keep(is.factor) |> 
    names()

# Inventar moda com essa função
rodar_chi <- function(variavel) {
    valor_p <- chisq.test(x = dados_peri[, variavel],
                          y = dados_peri$tb)$p.value
    
}

# Testando com duas variáveis
# Se fosse usar realmente, colocar o ID (nome da var) de alguma forma
purrr::map(c("apartip", "adiasem"), rodar_chi)
    
```



